<!DOCTYPE html>
<html>
<head>
  <title>Multi-Console Emulator (Fixed NES)</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; }
    #gameContainer canvas { border: 1px solid black; display: block; margin-top: 1rem; }
  </style>
</head>
<body>
  <h1>Multi-Console Emulator</h1>
  <label>Player Name: <input type="text" id="playerName" value="Player"></label>
  <label>Upload ROM: <input type="file" id="romUpload"></label>
  <label>Console:
    <select id="consoleSelect">
      <option value="nes">NES</option>
    </select>
  </label>
  <button id="startGame" disabled>Start Game</button>
  <div id="gameContainer"></div>

  <script src="jsnes.min.js"></script>
  <script>
    let romBuffer = null;
    let canvas, context, imageData;
    let nes;

    const romUpload = document.getElementById('romUpload');
    const startButton = document.getElementById('startGame');

    romUpload.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        romBuffer = new Uint8Array(e.target.result);
        startButton.disabled = false;
      };
      reader.readAsArrayBuffer(file);
    });

    function createCanvas() {
      canvas = document.createElement('canvas');
      canvas.width = 256;
      canvas.height = 240;
      context = canvas.getContext('2d');
      imageData = context.getImageData(0, 0, 256, 240);
      document.getElementById('gameContainer').innerHTML = '';
      document.getElementById('gameContainer').appendChild(canvas);
    }

    startButton.addEventListener('click', () => {
      const consoleType = document.getElementById('consoleSelect').value;
      const playerName = document.getElementById('playerName').value;

      if (consoleType === "nes" && romBuffer) {
        createCanvas();

        nes = new jsnes.NES({
          onFrame: function(frameBuffer) {
            for (let i = 0; i < frameBuffer.length; i++) {
              imageData.data[i] = frameBuffer[i];
            }
            context.putImageData(imageData, 0, 0);
          },
          onStatusUpdate: function() {}
        });

        nes.loadROM(romBuffer);
        nes.start();
      }
    });
  </script>
</body>
</html>
